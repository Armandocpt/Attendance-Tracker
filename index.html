<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance & Late Coming Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        /* Simple spinner for loading state */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Styles for active and inactive tabs */
        .tab-btn.active {
            border-bottom-color: #16a34a; /* green-600 */
            color: #16a34a;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- App Loading State -->
    <div id="app-loading" class="flex flex-col items-center justify-center h-screen">
        <div class="spinner"></div>
        <p class="mt-4 text-lg text-gray-600">Initializing App...</p>
    </div>

    <!-- Main App Content (hidden by default) -->
    <div id="app-container" class="hidden">
        <!-- Stationary Header -->
        <header class="sticky top-0 z-50 bg-green-600 shadow-lg">
            <div class="container mx-auto relative flex items-center justify-center text-center py-4 px-4 sm:px-6 lg:px-8">
                <div class="absolute left-4 sm:left-6 lg:left-8 flex items-center space-x-3">
                    <img src="https://placehold.co/60x60/4ade80/ffffff?text=Logo" alt="School Logo" class="h-12 w-12 rounded-full border-2 border-white">
                    <span class="text-xl font-bold text-white hidden md:block">School Name</span>
                </div>
                <div>
                    <h1 class="text-3xl sm:text-4xl font-bold text-white">Classroom Manager</h1>
                    <p id="classDetailsHeader" class="text-md text-green-100 mt-2">
                        <span id="displaySubjectName">[Subject]</span> | <span id="displayClassName">[Class]</span> | <span id="displayTeacherName">[Teacher]</span>
                    </p>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Tab Navigation -->
            <div class="mb-8 border-b border-gray-300">
                <nav class="flex space-x-8" aria-label="Tabs">
                    <button id="tab-attendance" class="tab-btn active font-medium text-lg py-4 px-1 border-b-4 border-transparent hover:border-gray-400 hover:text-gray-600 transition">
                        Attendance Tracker
                    </button>
                    <button id="tab-latecoming" class="tab-btn font-medium text-lg py-4 px-1 border-b-4 border-transparent hover:border-gray-400 hover:text-gray-600 transition">
                        Late Coming
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="content-attendance" class="tab-content">
                <!-- All existing sections will go here -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-semibold mb-4">Class Details</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="teacherName" class="block text-sm font-medium text-gray-700">Teacher Name</label>
                            <input type="text" id="teacherName" placeholder="e.g., Mr. Smith" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                        </div>
                        <div>
                            <label for="className" class="block text-sm font-medium text-gray-700">Class Name</label>
                            <input type="text" id="className" placeholder="e.g., Grade 10B" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                        </div>
                        <div class="sm:col-span-2">
                            <label for="subjectName" class="block text-sm font-medium text-gray-700">Subject Name</label>
                            <input type="text" id="subjectName" placeholder="e.g., Mathematics" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                        </div>
                    </div>
                    <div class="mt-6 text-right">
                        <button id="saveDetailsBtn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300">
                            Save Details
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md mb-8 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-semibold mb-4">Download Reports</h2>
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <label for="reportMonth" class="font-medium">Select Month:</label>
                        <input type="month" id="reportMonth" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                        <button id="downloadReportBtn" class="bg-emerald-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition duration-300">
                            Download Report
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md mb-8 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-semibold mb-4">Add a New Learner</h2>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="learnerName" placeholder="Enter learner's full name" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <button id="addLearnerBtn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 ease-in-out transform hover:-translate-y-1">
                            Add Learner
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md mb-8 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-semibold mb-4">Bulk Upload Learners</h2>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="file" id="csvFileInput" accept=".csv" class="flex-grow p-2 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        <button id="bulkAddBtn" class="bg-teal-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-300">
                            Upload CSV
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md mb-8 max-w-2xl mx-auto flex items-center justify-center gap-4">
                     <h2 class="text-2xl font-semibold">Date:</h2>
                     <input type="date" id="attendanceDate" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                </div>

                <div id="learnersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                 <div id="loading" class="text-center hidden">
                    <p class="text-lg text-gray-600">Loading learners...</p>
                </div>
            </div>

            <div id="content-latecoming" class="tab-content hidden">
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 max-w-4xl mx-auto">
                    <h2 class="text-2xl font-semibold mb-4">Late Learners for Today</h2>
                     <div class="flex items-center justify-center gap-4 mb-6">
                         <h3 class="text-xl font-semibold">Date:</h3>
                         <input type="date" id="lateDate" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                    <div id="lateLearnersList" class="space-y-3">
                        <!-- Late learners will be listed here -->
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Modals -->
        <div id="historyModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-full overflow-y-auto">
                <div class="p-6 border-b border-gray-200 sticky top-0 bg-white">
                    <h3 id="modalTitle" class="text-2xl font-bold">Attendance History</h3>
                    <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                </div>
                <div id="modalBody" class="p-6"></div>
            </div>
        </div>
        
        <div id="messageModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm"><div class="p-6 text-center"><p id="messageText" class="text-lg mb-6"></p><div id="messageActions" class="flex justify-center gap-4"></div></div></div>
        </div>

        <div id="noteModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm"><div class="p-6"><h3 id="noteModalTitle" class="text-xl font-bold mb-4">Add Note</h3><textarea id="attendanceNoteInput" class="w-full p-2 border border-gray-300 rounded-lg" rows="3" placeholder="Optional note..."></textarea><div class="mt-4 flex justify-end gap-4"><button id="cancelNoteBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-400">Cancel</button><button id="saveNoteBtn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700">Save</button></div></div></div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, setDoc, getDoc, deleteDoc, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase & App Config ---
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
            const firebaseConfig = {
              apiKey: "AIzaSyDaySiKZA6PrEgpxBw-v2pngSSBwYZpqUY",
              authDomain: "attendance-tracker-825cc.firebaseapp.com",
              projectId: "attendance-tracker-825cc",
              storageBucket: "attendance-tracker-825cc.firebasestorage.app",
              messagingSenderId: "539619569987",
              appId: "1:539619569987:web:15e9e25a8a7db639d63ff6",
              measurementId: "G-PQZBDQN0GL"
            };

        // --- UI Elements ---
        const el = (id) => document.getElementById(id);
        const appLoading = el('app-loading'), appContainer = el('app-container');
        const teacherNameInput = el('teacherName'), classNameInput = el('className'), subjectNameInput = el('subjectName');
        const saveDetailsBtn = el('saveDetailsBtn');
        const displayTeacherName = el('displayTeacherName'), displayClassName = el('displayClassName'), displaySubjectName = el('displaySubjectName');
        const addLearnerBtn = el('addLearnerBtn'), learnerNameInput = el('learnerName'), learnersList = el('learnersList');
        const attendanceDate = el('attendanceDate'), loading = el('loading');
        const historyModal = el('historyModal'), closeModalBtn = el('closeModalBtn'), modalTitle = el('modalTitle'), modalBody = el('modalBody');
        const messageModal = el('messageModal'), messageText = el('messageText'), messageActions = el('messageActions');
        const noteModal = el('noteModal'), noteModalTitle = el('noteModalTitle'), attendanceNoteInput = el('attendanceNoteInput'), cancelNoteBtn = el('cancelNoteBtn'), saveNoteBtn = el('saveNoteBtn');
        const reportMonthInput = el('reportMonth'), downloadReportBtn = el('downloadReportBtn');
        const csvFileInput = el('csvFileInput'), bulkAddBtn = el('bulkAddBtn');
        const tabAttendance = el('tab-attendance'), tabLateComing = el('tab-latecoming');
        const contentAttendance = el('content-attendance'), contentLateComing = el('content-latecoming');
        const lateDate = el('lateDate'), lateLearnersList = el('lateLearnersList');

        // --- App Initialization ---
        // This is the most reliable way to handle Firebase auth state.
        // It runs once on page load and handles both new sign-ins and existing sessions.
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // If a user object exists, the app is ready to go.
                console.log("Authentication successful. User ID:", user.uid);
                userId = user.uid;
                appLoading.classList.add('hidden');
                appContainer.classList.remove('hidden');
                loadClassDetails();
                loadLearners();
                loadLateLearners();
            } else {
                // If no user exists, it's the first visit. Attempt to sign in anonymously.
                // onAuthStateChanged will run *again* after this completes successfully.
                console.log("No user found. Attempting anonymous sign-in...");
                try {
                    if (typeof __firebase_config !== 'undefined' && typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error during initial sign-in:", error);
                    appLoading.innerHTML = `<p class="text-red-500">Could not connect to the database. Please check your Firebase setup and security rules.</p>`;
                }
            }
        });


        // --- Tab Logic ---
        function switchTab(activeTab) {
            [contentAttendance, contentLateComing].forEach(c => c.classList.add('hidden'));
            [tabAttendance, tabLateComing].forEach(t => t.classList.remove('active'));
            if (activeTab === 'attendance') {
                contentAttendance.classList.remove('hidden');
                tabAttendance.classList.add('active');
            } else {
                contentLateComing.classList.remove('hidden');
                tabLateComing.classList.add('active');
            }
        }
        tabAttendance.addEventListener('click', () => switchTab('attendance'));
        tabLateComing.addEventListener('click', () => switchTab('latecoming'));

        // --- Date Handling ---
        function getFormattedDate(dateObj) {
            return dateObj.toISOString().slice(0, 10);
        }
        const today = new Date();
        attendanceDate.value = getFormattedDate(today);
        lateDate.value = getFormattedDate(today);
        reportMonthInput.value = today.toISOString().slice(0, 7);
        attendanceDate.addEventListener('change', loadLearners);
        lateDate.addEventListener('change', loadLateLearners);

        // --- Firestore Path Helpers ---
        const paths = {
            learners: () => collection(db, `/artifacts/${appId}/users/${userId}/learners`),
            attendance: () => collection(db, `/artifacts/${appId}/users/${userId}/attendance`),
            classDetails: () => doc(db, `/artifacts/${appId}/users/${userId}/settings/classDetails`)
        };

        // --- Core Functions (unchanged logic, just using path helpers) ---
        async function saveClassDetails() {
            const details = { teacherName: teacherNameInput.value.trim(), className: classNameInput.value.trim(), subjectName: subjectNameInput.value.trim() };
            try { await setDoc(paths.classDetails(), details); showMessage("Details saved!"); } 
            catch (e) { console.error(e); showMessage("Failed to save details."); }
        }

        function loadClassDetails() {
            onSnapshot(paths.classDetails(), (doc) => {
                const d = doc.exists() ? doc.data() : {};
                teacherNameInput.value = d.teacherName || '';
                classNameInput.value = d.className || '';
                subjectNameInput.value = d.subjectName || '';
                displayTeacherName.textContent = d.teacherName || '[Teacher]';
                displayClassName.textContent = d.className || '[Class]';
                displaySubjectName.textContent = d.subjectName || '[Subject]';
            });
        }

        async function addLearner() {
            const name = learnerNameInput.value.trim();
            if (!name) return showMessage("Learner name is empty.");
            try { await addDoc(paths.learners(), { name, createdAt: new Date() }); learnerNameInput.value = ''; } 
            catch (e) { console.error(e); showMessage("Error adding learner."); }
        }

        async function bulkAddLearners(names) {
            if (!names || names.length === 0) return showMessage("No names found.");
            const batch = writeBatch(db);
            names.forEach(name => batch.set(doc(paths.learners()), { name, createdAt: new Date() }));
            try { await batch.commit(); showMessage(`Added ${names.length} learners.`); csvFileInput.value = ''; } 
            catch (e) { console.error(e); showMessage("Bulk upload failed."); }
        }

        function loadLearners() {
            loading.classList.remove('hidden');
            learnersList.innerHTML = '';
            onSnapshot(query(paths.learners()), async (snapshot) => {
                loading.classList.add('hidden');
                if (snapshot.empty) return learnersList.innerHTML = '<p class="text-center col-span-full">No learners added yet.</p>';
                const learners = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.name.localeCompare(b.name));
                const attendancePromises = learners.map(l => getAttendanceForDate(l.id, attendanceDate.value));
                const attendanceRecords = await Promise.all(attendancePromises);
                learnersList.innerHTML = learners.map((learner, i) => createLearnerCardHTML(learner, attendanceRecords[i])).join('');
            });
        }

        function createLearnerCardHTML(learner, attendance) {
            const status = attendance?.status || 'Not Marked';
            const note = attendance?.note || '';
            let statusColorClass = 'text-gray-500';
            if (status === 'Present') statusColorClass = 'text-green-600';
            if (status === 'Absent') statusColorClass = 'text-red-600';
            if (status === 'Late') statusColorClass = 'text-yellow-600';
            return `
                <div class="bg-white p-5 rounded-xl shadow-lg flex flex-col space-y-4 border-2 ${status === 'Not Marked' ? 'border-gray-200' : status === 'Present' ? 'border-green-500' : status === 'Absent' ? 'border-red-500' : 'border-yellow-500'}" data-id="${learner.id}">
                    <div class="flex-grow">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-900">${learner.name}</h3>
                            ${note ? '<span title="Has note" class="text-blue-500">📝</span>' : ''}
                        </div>
                        <p class="text-sm text-gray-500">Status: <span class="font-semibold ${statusColorClass}">${status}</span></p>
                    </div>
                    <div class="flex flex-wrap gap-2 justify-center">
                        <button class="status-btn flex-1 bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition" data-status="Present">Present</button>
                        <button class="status-btn flex-1 bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition" data-status="Absent">Absent</button>
                        <button class="status-btn flex-1 bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 transition" data-status="Late">Late</button>
                    </div>
                    <div class="pt-2 border-t border-gray-200 mt-4 flex justify-between items-center">
                         <button class="view-history-btn text-sm text-indigo-600 hover:underline">View History</button>
                         <button class="delete-learner-btn text-sm text-red-600 hover:underline">Delete</button>
                    </div>
                </div>`;
        }

        async function getAttendanceForDate(learnerId, date) {
            const attendanceId = `${learnerId}_${date}`;
            const docRef = doc(paths.attendance(), attendanceId);
            const docSnap = await getDoc(docRef);
            return docSnap.exists() ? {id: docSnap.id, ...docSnap.data()} : null;
        }

        async function setAttendance(learnerId, status, date, note = '') {
            const attendanceId = `${learnerId}_${date}`;
            const docRef = doc(paths.attendance(), attendanceId);
            try {
                await setDoc(docRef, { learnerId, date, status, note, updatedAt: new Date() });
                loadLearners();
                if (status === 'Late') loadLateLearners();
            } catch (e) { console.error("Error setting attendance: ", e); }
        }
        
        async function deleteLearner(learnerId) {
            try {
                await deleteDoc(doc(paths.learners(), learnerId));
                const q = query(paths.attendance(), where("learnerId", "==", learnerId));
                const snapshot = await getDocs(q);
                const batch = writeBatch(db);
                snapshot.forEach(d => batch.delete(d.ref));
                await batch.commit();
            } catch (e) { console.error("Error deleting learner: ", e); showMessage("Error deleting learner."); }
        }

        // --- Late Comers Logic ---
        async function loadLateLearners() {
            const date = lateDate.value;
            const q = query(paths.attendance(), where("date", "==", date), where("status", "==", "Late"));
            onSnapshot(q, async (snapshot) => {
                if (snapshot.empty) {
                    lateLearnersList.innerHTML = '<p class="text-center text-gray-500">No late learners recorded for this date.</p>';
                    return;
                }
                const learnerIds = snapshot.docs.map(d => d.data().learnerId);
                const learnerDocs = await Promise.all(learnerIds.map(id => getDoc(doc(paths.learners(), id))));
                const learnersMap = new Map(learnerDocs.map(d => [d.id, d.data()?.name || 'Unknown']));
                
                lateLearnersList.innerHTML = snapshot.docs.map(d => {
                    const record = d.data();
                    return `
                        <div class="bg-gray-50 p-4 rounded-lg flex justify-between items-center">
                            <span class="font-bold text-lg">${learnersMap.get(record.learnerId)}</span>
                            <span class="text-sm text-gray-600">${record.note ? `Note: ${record.note}` : 'No note'}</span>
                        </div>`;
                }).join('');
            });
        }

        // --- Event Listeners ---
        saveDetailsBtn.addEventListener('click', saveClassDetails);
        addLearnerBtn.addEventListener('click', addLearner);
        learnerNameInput.addEventListener('keypress', (e) => e.key === 'Enter' && addLearner());
        bulkAddBtn.addEventListener('click', () => {
            const file = csvFileInput.files[0];
            if (!file) return showMessage("Please select a CSV file.");
            const reader = new FileReader();
            reader.onload = (e) => bulkAddLearners(e.target.result.split(/\r?\n/).map(n => n.trim()).filter(Boolean));
            reader.readAsText(file);
        });
        learnersList.addEventListener('click', (e) => {
            const card = e.target.closest('[data-id]');
            if (!card) return;
            const learnerId = card.dataset.id;
            const learnerName = card.querySelector('h3').textContent;
            const date = attendanceDate.value;

            if (e.target.matches('.status-btn')) {
                const status = e.target.dataset.status;
                if (status === 'Absent' || status === 'Late') openNoteModal(learnerId, status, date, learnerName);
                else setAttendance(learnerId, status, date);
            } else if (e.target.matches('.view-history-btn')) {
                openHistoryModal(learnerId, learnerName);
            } else if (e.target.matches('.delete-learner-btn')) {
                showConfirmation('Delete this learner and all their records?', () => deleteLearner(learnerId));
            }
        });
        
        // --- Modals ---
        function showMessage(message) {
            messageText.textContent = message;
            messageActions.innerHTML = `<button id="messageOkBtn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700">OK</button>`;
            el('messageOkBtn').onclick = () => messageModal.classList.add('hidden');
            messageModal.classList.remove('hidden');
        }
        function showConfirmation(message, onConfirm) {
            messageText.textContent = message;
            messageActions.innerHTML = `<button id="confirmYesBtn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700">Yes</button><button id="confirmNoBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-400">Cancel</button>`;
            messageModal.classList.remove('hidden');
            el('confirmYesBtn').onclick = () => { onConfirm(); messageModal.classList.add('hidden'); };
            el('confirmNoBtn').onclick = () => messageModal.classList.add('hidden');
        }
        function openNoteModal(learnerId, status, date, learnerName) {
            noteModalTitle.textContent = `Add Note for ${learnerName} (${status})`;
            attendanceNoteInput.value = '';
            noteModal.classList.remove('hidden');
            saveNoteBtn.onclick = () => {
                setAttendance(learnerId, status, date, attendanceNoteInput.value.trim());
                noteModal.classList.add('hidden');
            };
        }
        cancelNoteBtn.addEventListener('click', () => noteModal.classList.add('hidden'));
        async function openHistoryModal(learnerId, learnerName) {
            modalTitle.textContent = `History for ${learnerName}`;
            modalBody.innerHTML = '<p>Loading...</p>';
            historyModal.classList.remove('hidden');
            const q = query(paths.attendance(), where("learnerId", "==", learnerId));
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) return modalBody.innerHTML = '<p>No records found.</p>';
                const records = snapshot.docs.map(d => d.data()).sort((a, b) => new Date(b.date) - new Date(a.date));
                const absentCount = records.filter(r => r.status === 'Absent').length;
                const lateCount = records.filter(r => r.status === 'Late').length;
                const summaryHtml = `<div class="bg-gray-100 p-4 rounded-lg mb-4 flex justify-around text-center"><div><p class="text-2xl font-bold text-red-600">${absentCount}</p><p class="text-sm text-gray-600">Absences</p></div><div><p class="text-2xl font-bold text-yellow-600">${lateCount}</p><p class="text-sm text-gray-600">Lates</p></div></div>`;
                const historyHtml = '<ul class="space-y-3">' + records.map(r => {
                    const color = r.status === 'Present' ? 'text-green-600' : r.status === 'Absent' ? 'text-red-600' : 'text-yellow-600';
                    return `<li class="bg-gray-50 p-3 rounded-md"><div class="flex justify-between items-center"><span class="font-medium">${r.date}</span><span class="font-semibold ${color}">${r.status}</span></div>${r.note ? `<p class="text-sm text-gray-600 mt-1 pl-1 border-l-2 border-gray-300">Note: ${r.note}</p>` : ''}</li>`;
                }).join('') + '</ul>';
                modalBody.innerHTML = summaryHtml + historyHtml;
            });
        }
        closeModalBtn.addEventListener('click', () => historyModal.classList.add('hidden'));
        historyModal.addEventListener('click', (e) => e.target === historyModal && historyModal.classList.add('hidden'));

        // --- Report Generation ---
        async function generateReport() {
            const monthYear = reportMonthInput.value;
            if (!monthYear) return showMessage("Please select a month.");
            const [year, month] = monthYear.split('-');
            const startDate = `${year}-${month}-01`;
            const lastDay = new Date(year, month, 0).getDate();
            const endDate = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;
            
            const learnersSnap = await getDocs(paths.learners());
            const learnersMap = new Map(learnersSnap.docs.map(d => [d.id, d.data().name]));

            const q = query(paths.attendance(), where("date", ">=", startDate), where("date", "<=", endDate));
            const attendanceSnap = await getDocs(q);
            if (attendanceSnap.empty) return showMessage("No records for this month.");

            let csvContent = "data:text/csv;charset=utf-8,Learner Name,Date,Status,Note\r\n";
            const records = attendanceSnap.docs.map(d => d.data()).sort((a,b) => new Date(a.date) - new Date(b.date) || (learnersMap.get(a.learnerId) || '').localeCompare(learnersMap.get(b.learnerId) || ''));
            records.forEach(r => {
                const name = learnersMap.get(r.learnerId) || "Unknown";
                const note = r.note ? r.note.replace(/,/g, ";") : "";
                csvContent += `${name},${r.date},${r.status},${note}\r.n`;
            });

            const link = document.createElement("a");
            link.href = encodeURI(csvContent);
            link.download = `attendance_report_${year}_${month}.csv`;
            link.click();
        }
        downloadReportBtn.addEventListener('click', generateReport);
    </script>
</body>
</html>
