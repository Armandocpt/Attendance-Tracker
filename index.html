<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance & Late Coming Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { transition: opacity 0.3s ease; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-btn.active { border-bottom-color: #16a34a; color: #16a34a; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-loading" class="flex flex-col items-center justify-center h-screen">
        <div class="spinner"></div>
        <p class="mt-4 text-lg text-gray-600">Initializing App...</p>
    </div>

    <div id="app-container" class="hidden">
        <header class="sticky top-0 z-50 bg-green-600 shadow-lg">
            <div class="container mx-auto relative flex items-center justify-center text-center py-4 px-4 sm:px-6 lg:px-8">
                <div class="absolute left-4 sm:left-6 lg:left-8 flex items-center space-x-3">
                    <img src="https://placehold.co/60x60/4ade80/ffffff?text=Logo" alt="School Logo" class="h-12 w-12 rounded-full border-2 border-white">
                    <span class="text-xl font-bold text-white hidden md:block">School Name</span>
                </div>
                <div>
                    <h1 class="text-3xl sm:text-4xl font-bold text-white">Classroom Manager</h1>
                    <p id="classDetailsHeader" class="text-md text-green-100 mt-2">
                        <span id="displaySubjectName">[Subject]</span> | <span id="displayClassName">[Class]</span> | <span id="displayTeacherName">[Teacher]</span>
                    </p>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div class="mb-8 border-b border-gray-300">
                <nav class="flex space-x-8" aria-label="Tabs">
                    <button id="tab-attendance" class="tab-btn active font-medium text-lg py-4 px-1 border-b-4 border-transparent hover:border-gray-400 hover:text-gray-600 transition">My Private Tracker</button>
                    <button id="tab-latecoming" class="tab-btn font-medium text-lg py-4 px-1 border-b-4 border-transparent hover:border-gray-400 hover:text-gray-600 transition">School Late Coming</button>
                </nav>
            </div>

            <div id="content-attendance" class="tab-content">
                <!-- All sections for the private attendance tracker will be injected here -->
            </div>

            <div id="content-latecoming" class="tab-content hidden">
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 max-w-4xl mx-auto">
                    <h2 class="text-2xl font-semibold mb-4">Record Late Learners</h2>
                    <div class="flex flex-col sm:flex-row items-center gap-4 mb-6 bg-gray-50 p-4 rounded-lg">
                         <label for="classSelector" class="text-xl font-semibold">Select Class:</label>
                         <select id="classSelector" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                            <option value="">-- Loading Classes --</option>
                         </select>
                    </div>
                    <div id="learnersToMarkList" class="space-y-3">
                        <p class="text-center text-gray-500">Please select a class to see the learners.</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md mb-8 max-w-4xl mx-auto">
                    <h2 class="text-2xl font-semibold mb-4">Daily Late Coming List</h2>
                    <div class="flex items-center justify-center gap-4 mb-6">
                         <h3 class="text-xl font-semibold">Date:</h3>
                         <input type="date" id="lateListDate" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                    <div id="recordedLateList" class="space-y-3">
                        <!-- Late learners will be listed here -->
                    </div>
                </div>
            </div>
        </main>
        
        <!-- All Modals -->
        <div id="historyModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-full overflow-y-auto">
                <div class="p-6 border-b border-gray-200 sticky top-0 bg-white">
                    <h3 id="modalTitle" class="text-2xl font-bold">Attendance History</h3>
                    <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                </div>
                <div id="modalBody" class="p-6"></div>
            </div>
        </div>
        
        <div id="messageModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm"><div class="p-6 text-center"><p id="messageText" class="text-lg mb-6"></p><div id="messageActions" class="flex justify-center gap-4"></div></div></div>
        </div>

        <div id="noteModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm"><div class="p-6"><h3 id="noteModalTitle" class="text-xl font-bold mb-4">Add Note</h3><textarea id="attendanceNoteInput" class="w-full p-2 border border-gray-300 rounded-lg" rows="3" placeholder="Optional note..."></textarea><div class="mt-4 flex justify-end gap-4"><button id="cancelNoteBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-400">Cancel</button><button id="saveNoteBtn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700">Save</button></div></div></div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, setDoc, getDoc, deleteDoc, query, where, getDocs, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase & App Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDaySiKZA6PrEgpxBw-v2pngSSBwYZpqUY",
            authDomain: "attendance-tracker-825cc.firebaseapp.com",
            projectId: "attendance-tracker-825cc",
            storageBucket: "attendance-tracker-825cc.appspot.com",
            messagingSenderId: "539619569987",
            appId: "1:539619569987:web:15e9e25a8a7db639d63ff6",
            measurementId: "G-PQZBDQN0GL"
        };
        
        const appId = 'default-attendance-app'; // Use a consistent app ID
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userId = null;

        // --- UI Elements ---
        const el = (id) => document.getElementById(id);
        const appLoading = el('app-loading'), appContainer = el('app-container');
        const contentAttendance = el('content-attendance'), contentLateComing = el('content-latecoming');
        const tabAttendance = el('tab-attendance'), tabLateComing = el('tab-latecoming');
        const classSelector = el('classSelector'), learnersToMarkList = el('learnersToMarkList');
        const lateListDate = el('lateListDate'), recordedLateList = el('recordedLateList');
        const historyModal = el('historyModal'), closeModalBtn = el('closeModalBtn'), modalTitle = el('modalTitle'), modalBody = el('modalBody');
        const noteModal = el('noteModal'), cancelNoteBtn = el('cancelNoteBtn');

        // --- App Initialization ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                appLoading.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                // Setup both tabs
                setupPrivateTracker();
                setupLateComingTracker();

            } else {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Error during initial sign-in:", error);
                    appLoading.innerHTML = `<p class="text-red-500">Could not connect. Check Firebase setup.</p>`;
                }
            }
        });

        // --- Tab Logic ---
        function switchTab(activeTab) {
            [contentAttendance, contentLateComing].forEach(c => c.classList.add('hidden'));
            [tabAttendance, tabLateComing].forEach(t => t.classList.remove('active'));
            if (activeTab === 'attendance') {
                contentAttendance.classList.remove('hidden');
                tabAttendance.classList.add('active');
            } else {
                contentLateComing.classList.remove('hidden');
                tabLateComing.classList.add('active');
            }
        }
        tabAttendance.addEventListener('click', () => switchTab('attendance'));
        tabLateComing.addEventListener('click', () => switchTab('latecoming'));

        // =====================================================================
        // LATE COMING TRACKER (SHARED DATA)
        // =====================================================================
        
        // --- Helper function to provide correct security rules ---
        function getSecureRules() {
            return `rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Rule 1: Secures private data
    match /artifacts/{appId}/users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    // Rule 2: Allows reading the list of shared classes and learners
    match /classes/{classId}/{document=**} {
      allow read: if request.auth != null;
    }
    // Rule 3: Allows reading and writing to the shared late records
    match /lateRecords/{recordId} {
      allow read, write: if request.auth != null;
    }
  }
}`;
        }

        async function setupLateComingTracker() {
            lateListDate.value = new Date().toISOString().slice(0, 10);
            lateListDate.addEventListener('change', loadRecordedLateLearners);
            loadRecordedLateLearners(); // Initial load for today

            try {
                const classesCol = collection(db, 'classes');
                const snapshot = await getDocs(classesCol);
                
                if (snapshot.empty) {
                    classSelector.innerHTML = '<option value="">-- No classes found --</option>';
                    return;
                }

                const classes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.className.localeCompare(b.className));
                classSelector.innerHTML = '<option value="">-- Select a Class --</option>';
                classes.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = c.className;
                    classSelector.appendChild(option);
                });

                classSelector.addEventListener('change', () => {
                    const classId = classSelector.value;
                    if (classId) {
                        loadLearnersForClass(classId);
                    } else {
                        learnersToMarkList.innerHTML = '<p class="text-center text-gray-500">Please select a class to see the learners.</p>';
                    }
                });
            } catch (error) {
                if (error.code === 'permission-denied') {
                    alert("SECURITY RULE ERROR:\nThe app is not allowed to read the list of classes. Please go to your Firebase project -> Firestore -> Rules and paste the following rules:\n\n" + getSecureRules());
                    classSelector.innerHTML = '<option value="">-- Permission Denied --</option>';
                } else {
                    console.error("Error loading classes:", error);
                    classSelector.innerHTML = '<option value="">-- Error Loading Classes --</option>';
                }
            }
        }

        async function loadLearnersForClass(classId) {
            learnersToMarkList.innerHTML = '<p class="text-center text-gray-500">Loading learners...</p>';
            try {
                const learnersCol = collection(db, `classes/${classId}/learners`);
                const snapshot = await getDocs(learnersCol);

                if (snapshot.empty) {
                    learnersToMarkList.innerHTML = '<p class="text-center text-gray-500">No learners found for this class.</p>';
                    return;
                }

                const learners = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.name.localeCompare(b.name));
                learnersToMarkList.innerHTML = learners.map(learner => `
                    <div class="bg-gray-50 p-4 rounded-lg flex flex-col sm:flex-row justify-between items-center" data-learner-id="${learner.id}" data-learner-name="${learner.name}" data-class-id="${classId}">
                        <span class="font-bold text-lg mb-2 sm:mb-0">${learner.name}</span>
                        <button class="mark-late-btn bg-yellow-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-yellow-600 transition w-full sm:w-auto">Mark as Late</button>
                    </div>
                `).join('');
            } catch (error) {
                 if (error.code === 'permission-denied') {
                    alert("SECURITY RULE ERROR:\nThe app is not allowed to read learners for this class. Please go to your Firebase project -> Firestore -> Rules and paste the following rules:\n\n" + getSecureRules());
                    learnersToMarkList.innerHTML = '<p class="text-center text-red-500">Permission Denied. Check security rules.</p>';
                } else {
                    console.error("Error loading learners:", error);
                    learnersToMarkList.innerHTML = '<p class="text-center text-red-500">Error loading learners.</p>';
                }
            }
        }

        learnersToMarkList.addEventListener('click', (e) => {
            if (e.target.classList.contains('mark-late-btn')) {
                const container = e.target.closest('[data-learner-id]');
                const { learnerId, learnerName, classId } = container.dataset;
                const note = prompt(`Add an optional note for ${learnerName}:`);
                
                if (note !== null) { // Will be null if user clicks cancel
                    recordLateComing(classId, learnerId, learnerName, note);
                }
            }
        });

        async function recordLateComing(classId, learnerId, learnerName, note) {
            try {
                const lateCol = collection(db, 'lateRecords');
                await addDoc(lateCol, {
                    classId,
                    learnerId,
                    learnerName,
                    note: note || "No note provided",
                    date: new Date().toISOString().slice(0, 10),
                    timestamp: serverTimestamp(),
                    recordedBy: userId
                });
                alert(`${learnerName} has been recorded as late.`);
            } catch (error) {
                console.error("Error recording late coming:", error);
                alert("Failed to record late coming. Please try again.");
            }
        }

        async function loadRecordedLateLearners() {
            const date = lateListDate.value;
            recordedLateList.innerHTML = '<p class="text-center text-gray-500">Loading late list...</p>';

            const classesSnap = await getDocs(collection(db, 'classes'));
            const classesMap = new Map(classesSnap.docs.map(doc => [doc.id, doc.data().className]));

            const q = query(collection(db, 'lateRecords'), where("date", "==", date));
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    recordedLateList.innerHTML = '<p class="text-center text-gray-500">No learners were recorded late on this date.</p>';
                    return;
                }

                const records = snapshot.docs.map(doc => doc.data()).sort((a,b) => a.timestamp - b.timestamp);

                recordedLateList.innerHTML = records.map(record => {
                    const className = classesMap.get(record.classId) || 'Unknown Class';
                    return `
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-lg">${record.learnerName}</span>
                                <span class="text-sm font-medium text-gray-700">${className}</span>
                            </div>
                            ${record.note ? `<p class="text-sm text-gray-600 mt-1 pl-1 border-l-2 border-gray-300">Note: ${record.note}</p>` : ''}
                        </div>
                    `;
                }).join('');
            }, (error) => {
                 if (error.code === 'permission-denied') {
                    alert("SECURITY RULE ERROR:\nThe app is not allowed to read the daily late list. Please go to your Firebase project -> Firestore -> Rules and paste the following rules:\n\n" + getSecureRules());
                    recordedLateList.innerHTML = '<p class="text-center text-red-500">Permission Denied. Check security rules.</p>';
                } else {
                    console.error("Error loading late records:", error);
                    recordedLateList.innerHTML = '<p class="text-center text-red-500">Could not load late records.</p>';
                }
            });
        }


        // =====================================================================
        // PRIVATE ATTENDANCE TRACKER (INDIVIDUAL TEACHER DATA)
        // =====================================================================
        function setupPrivateTracker() {
            // Inject the HTML for the private tracker into its container
            contentAttendance.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-semibold mb-4">My Class Details</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div><label for="teacherName" class="block text-sm font-medium text-gray-700">My Name</label><input type="text" id="teacherName" class="mt-1 block w-full p-3 border rounded-lg"></div>
                        <div><label for="className" class="block text-sm font-medium text-gray-700">My Class Name</label><input type="text" id="className" class="mt-1 block w-full p-3 border rounded-lg"></div>
                        <div class="sm:col-span-2"><label for="subjectName" class="block text-sm font-medium text-gray-700">My Subject</label><input type="text" id="subjectName" class="mt-1 block w-full p-3 border rounded-lg"></div>
                    </div>
                    <div class="mt-6 text-right"><button id="saveDetailsBtn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">Save Details</button></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-semibold mb-4">Download My Reports</h2>
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <label for="reportMonth" class="font-medium">Select Month:</label>
                        <input type="month" id="reportMonth" class="p-3 border rounded-lg">
                        <button id="downloadReportBtn" class="bg-emerald-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-emerald-700">Download Report</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-semibold mb-4">Add a New Learner to My List</h2>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="learnerName" class="flex-grow p-3 border rounded-lg">
                        <button id="addLearnerBtn" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700">Add Learner</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-semibold mb-4">Bulk Upload My Learners</h2>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="file" id="csvFileInput" accept=".csv" class="flex-grow p-2 border rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-indigo-50 hover:file:bg-indigo-100">
                        <button id="bulkAddBtn" class="bg-teal-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-700">Upload CSV</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 max-w-2xl mx-auto flex items-center justify-center gap-4">
                     <h2 class="text-2xl font-semibold">Date:</h2>
                     <input type="date" id="attendanceDate" class="p-3 border rounded-lg">
                </div>
                <div id="learnersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="loading" class="text-center hidden"><p class="text-lg">Loading...</p></div>
            `;
            // Re-bind event listeners for the newly injected elements
            bindPrivateTrackerEvents();
        }

        function bindPrivateTrackerEvents() {
            // This function is necessary because the elements are added dynamically
            el('saveDetailsBtn').addEventListener('click', savePrivateClassDetails);
            el('addLearnerBtn').addEventListener('click', addPrivateLearner);
            el('bulkAddBtn').addEventListener('click', () => {
                const file = el('csvFileInput').files[0];
                if (!file) return alert("Please select a CSV file.");
                const reader = new FileReader();
                reader.onload = (e) => bulkAddPrivateLearners(e.target.result.split(/\r?\n/).map(n => n.trim()).filter(Boolean));
                reader.readAsText(file);
            });
            el('learnersList').addEventListener('click', handlePrivateLearnerClick);
            el('downloadReportBtn').addEventListener('click', generatePrivateReport);
            el('attendanceDate').value = new Date().toISOString().slice(0, 10);
            el('reportMonth').value = new Date().toISOString().slice(0, 7);
            el('attendanceDate').addEventListener('change', loadPrivateLearners);
        }

        // All the original functions, now renamed to be specific to the private tracker
        const privatePaths = {
            learners: () => collection(db, `/artifacts/${appId}/users/${userId}/learners`),
            attendance: () => collection(db, `/artifacts/${appId}/users/${userId}/attendance`),
            classDetails: () => doc(db, `/artifacts/${appId}/users/${userId}/settings/classDetails`)
        };

        async function savePrivateClassDetails() {
            const details = { teacherName: el('teacherName').value.trim(), className: el('className').value.trim(), subjectName: el('subjectName').value.trim() };
            try { await setDoc(privatePaths.classDetails(), details); alert("Details saved!"); } 
            catch (e) { console.error(e); alert("Failed to save details."); }
        }

        function loadClassDetails() {
            onSnapshot(privatePaths.classDetails(), (doc) => {
                const d = doc.exists() ? doc.data() : {};
                el('teacherName').value = d.teacherName || '';
                el('className').value = d.className || '';
                el('subjectName').value = d.subjectName || '';
                el('displayTeacherName').textContent = d.teacherName || '[Teacher]';
                el('displayClassName').textContent = d.className || '[Class]';
                el('displaySubjectName').textContent = d.subjectName || '[Subject]';
            });
        }

        async function addPrivateLearner() {
            const name = el('learnerName').value.trim();
            if (!name) return alert("Learner name is empty.");
            try { await addDoc(privatePaths.learners(), { name, createdAt: new Date() }); el('learnerName').value = ''; } 
            catch (e) { console.error(e); alert("Error adding learner."); }
        }
        
        async function bulkAddPrivateLearners(names) {
            if (!names || names.length === 0) return alert("No names found.");
            const batch = writeBatch(db);
            names.forEach(name => batch.set(doc(privatePaths.learners()), { name, createdAt: new Date() }));
            try { await batch.commit(); alert(`Added ${names.length} learners.`); el('csvFileInput').value = ''; } 
            catch (e) { console.error(e); alert("Bulk upload failed."); }
        }

        function loadPrivateLearners() {
            el('loading').classList.remove('hidden');
            el('learnersList').innerHTML = '';
            onSnapshot(query(privatePaths.learners()), async (snapshot) => {
                el('loading').classList.add('hidden');
                if (snapshot.empty) return el('learnersList').innerHTML = '<p class="text-center col-span-full">No learners added yet.</p>';
                const learners = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.name.localeCompare(b.name));
                const attendancePromises = learners.map(l => getPrivateAttendanceForDate(l.id, el('attendanceDate').value));
                const attendanceRecords = await Promise.all(attendancePromises);
                el('learnersList').innerHTML = learners.map((learner, i) => createPrivateLearnerCardHTML(learner, attendanceRecords[i])).join('');
            });
        }

        function createPrivateLearnerCardHTML(learner, attendance) {
             const status = attendance?.status || 'Not Marked';
            const note = attendance?.note || '';
            let statusColorClass = 'text-gray-500';
            if (status === 'Present') statusColorClass = 'text-green-600';
            if (status === 'Absent') statusColorClass = 'text-red-600';
            if (status === 'Late') statusColorClass = 'text-yellow-600';
            return `
                <div class="bg-white p-5 rounded-xl shadow-lg flex flex-col space-y-4 border-2 ${status === 'Not Marked' ? 'border-gray-200' : status === 'Present' ? 'border-green-500' : status === 'Absent' ? 'border-red-500' : 'border-yellow-500'}" data-id="${learner.id}">
                    <div class="flex-grow">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-900">${learner.name}</h3>
                            ${note ? '<span title="Has note" class="text-blue-500">📝</span>' : ''}
                        </div>
                        <p class="text-sm text-gray-500">Status: <span class="font-semibold ${statusColorClass}">${status}</span></p>
                    </div>
                    <div class="flex flex-wrap gap-2 justify-center">
                        <button class="status-btn flex-1 bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition" data-status="Present">Present</button>
                        <button class="status-btn flex-1 bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition" data-status="Absent">Absent</button>
                        <button class="status-btn flex-1 bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 transition" data-status="Late">Late</button>
                    </div>
                    <div class="pt-2 border-t border-gray-200 mt-4 flex justify-between items-center">
                         <button class="view-history-btn text-sm text-indigo-600 hover:underline">View History</button>
                         <button class="delete-learner-btn text-sm text-red-600 hover:underline">Delete</button>
                    </div>
                </div>`;
        }
        
        async function getPrivateAttendanceForDate(learnerId, date) {
            const docRef = doc(privatePaths.attendance(), `${learnerId}_${date}`);
            const docSnap = await getDoc(docRef);
            return docSnap.exists() ? {id: docSnap.id, ...docSnap.data()} : null;
        }

        async function setPrivateAttendance(learnerId, status, date, note = '') {
            const docRef = doc(privatePaths.attendance(), `${learnerId}_${date}`);
            try {
                await setDoc(docRef, { learnerId, date, status, note, updatedAt: new Date() });
                loadPrivateLearners();
            } catch (e) { console.error("Error setting attendance: ", e); }
        }

        async function deletePrivateLearner(learnerId) {
            try {
                await deleteDoc(doc(privatePaths.learners(), learnerId));
                const q = query(privatePaths.attendance(), where("learnerId", "==", learnerId));
                const snapshot = await getDocs(q);
                const batch = writeBatch(db);
                snapshot.forEach(d => batch.delete(d.ref));
                await batch.commit();
            } catch (e) { console.error("Error deleting learner: ", e); alert("Error deleting learner."); }
        }
        
        function handlePrivateLearnerClick(e) {
            const card = e.target.closest('[data-id]');
            if (!card) return;
            const learnerId = card.dataset.id;
            const learnerName = card.querySelector('h3').textContent;
            const date = el('attendanceDate').value;

            if (e.target.matches('.status-btn')) {
                const status = e.target.dataset.status;
                if (status === 'Absent' || status === 'Late') openPrivateNoteModal(learnerId, status, date, learnerName);
                else setPrivateAttendance(learnerId, status, date);
            } else if (e.target.matches('.view-history-btn')) {
                openPrivateHistoryModal(learnerId, learnerName);
            } else if (e.target.matches('.delete-learner-btn')) {
                if (confirm('Delete this learner and all their records?')) deletePrivateLearner(learnerId);
            }
        }
        
        function openPrivateNoteModal(learnerId, status, date, learnerName) {
            el('noteModalTitle').textContent = `Add Note for ${learnerName} (${status})`;
            el('attendanceNoteInput').value = '';
            noteModal.classList.remove('hidden');
            el('saveNoteBtn').onclick = () => {
                setPrivateAttendance(learnerId, status, date, el('attendanceNoteInput').value.trim());
                noteModal.classList.add('hidden');
            };
        }
        cancelNoteBtn.addEventListener('click', () => noteModal.classList.add('hidden'));

        async function openPrivateHistoryModal(learnerId, learnerName) {
            modalTitle.textContent = `History for ${learnerName}`;
            modalBody.innerHTML = '<p>Loading...</p>';
            historyModal.classList.remove('hidden');
            const q = query(privatePaths.attendance(), where("learnerId", "==", learnerId));
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) return modalBody.innerHTML = '<p>No records found.</p>';
                const records = snapshot.docs.map(d => d.data()).sort((a, b) => new Date(b.date) - new Date(a.date));
                const absentCount = records.filter(r => r.status === 'Absent').length;
                const lateCount = records.filter(r => r.status === 'Late').length;
                const summaryHtml = `<div class="bg-gray-100 p-4 rounded-lg mb-4 flex justify-around text-center"><div><p class="text-2xl font-bold text-red-600">${absentCount}</p><p class="text-sm text-gray-600">Absences</p></div><div><p class="text-2xl font-bold text-yellow-600">${lateCount}</p><p class="text-sm text-gray-600">Lates</p></div></div>`;
                const historyHtml = '<ul class="space-y-3">' + records.map(r => {
                    const color = r.status === 'Present' ? 'text-green-600' : r.status === 'Absent' ? 'text-red-600' : 'text-yellow-600';
                    return `<li class="bg-gray-50 p-3 rounded-md"><div class="flex justify-between items-center"><span class="font-medium">${r.date}</span><span class="font-semibold ${color}">${r.status}</span></div>${r.note ? `<p class="text-sm text-gray-600 mt-1 pl-1 border-l-2 border-gray-300">Note: ${r.note}</p>` : ''}</li>`;
                }).join('') + '</ul>';
                modalBody.innerHTML = summaryHtml + historyHtml;
            });
        }
        closeModalBtn.addEventListener('click', () => historyModal.classList.add('hidden'));
        
        async function generatePrivateReport() {
            const monthYear = el('reportMonth').value;
            if (!monthYear) return alert("Please select a month.");
            const [year, month] = monthYear.split('-');
            const startDate = `${year}-${month}-01`;
            const lastDay = new Date(year, month, 0).getDate();
            const endDate = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;
            
            const learnersSnap = await getDocs(privatePaths.learners());
            const learnersMap = new Map(learnersSnap.docs.map(d => [d.id, d.data().name]));

            const q = query(privatePaths.attendance(), where("date", ">=", startDate), where("date", "<=", endDate));
            const attendanceSnap = await getDocs(q);
            if (attendanceSnap.empty) return alert("No records for this month.");

            let csvContent = "data:text/csv;charset=utf-8,Learner Name,Date,Status,Note\r\n";
            const records = attendanceSnap.docs.map(d => d.data()).sort((a,b) => new Date(a.date) - new Date(b.date) || (learnersMap.get(a.learnerId) || '').localeCompare(learnersMap.get(b.learnerId) || ''));
            records.forEach(r => {
                const name = learnersMap.get(r.learnerId) || "Unknown";
                const note = r.note ? r.note.replace(/,/g, ";") : "";
                csvContent += `${name},${r.date},${r.status},${note}\r\n`;
            });

            const link = document.createElement("a");
            link.href = encodeURI(csvContent);
            link.download = `attendance_report_${year}_${month}.csv`;
            link.click();
        }
    </script>
</body>
</html>
