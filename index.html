<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance & Late Coming Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { transition: opacity 0.3s ease; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-btn.active { border-bottom-color: #16a34a; color: #16a34a; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-loading" class="flex flex-col items-center justify-center h-screen">
        <div class="spinner"></div>
        <p class="mt-4 text-lg text-gray-600">Initializing App...</p>
    </div>
    
    <div id="security-error-screen" class="hidden fixed inset-0 bg-red-100 p-8 z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-3xl mx-auto">
            <h1 class="text-3xl font-bold text-red-600 mb-4">Security Rule Error</h1>
            <p class="mb-4 text-gray-700">The app is being blocked by your database security rules. To fix this, please go to your Firebase project's **Firestore Database -> Rules** tab and replace the entire contents of the editor with the rules below:</p>
            <pre id="security-rules-display" class="bg-gray-800 text-left text-white p-4 rounded-lg text-xs overflow-x-auto whitespace-pre-wrap"></pre>
        </div>
    </div>


    <div id="app-container" class="hidden">
        <header class="sticky top-0 z-50 bg-green-600 shadow-lg">
            <div class="container mx-auto relative flex items-center justify-center text-center py-4 px-4 sm:px-6 lg:px-8 h-24">
                <div>
                    <h1 class="text-3xl sm:text-4xl font-bold text-white">Classroom Manager</h1>
                    <p id="classDetailsHeader" class="text-md text-green-100 mt-2">
                        <span id="displayClassName">[Select a Class]</span>
                    </p>
                </div>
            </div>
        </header>

        <!-- Sticky Tab Navigation -->
        <div class="sticky top-24 z-40 bg-white shadow-md">
            <main class="container mx-auto">
                <div class="border-b border-gray-300">
                    <nav class="flex space-x-8 px-4 sm:px-6 lg:px-8" aria-label="Tabs">
                        <button id="tab-attendance" class="tab-btn active font-medium text-lg py-4 px-1 border-b-4 border-transparent hover:border-gray-400 hover:text-gray-600 transition">Attendance Tracker</button>
                        <button id="tab-latecoming" class="tab-btn font-medium text-lg py-4 px-1 border-b-4 border-transparent hover:border-gray-400 hover:text-gray-600 transition">School Late Coming</button>
                        <button id="tab-dashboard" class="tab-btn font-medium text-lg py-4 px-1 border-b-4 border-transparent hover:border-gray-400 hover:text-gray-600 transition">Dashboard</button>
                    </nav>
                </div>
            </main>
        </div>

        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div id="content-attendance" class="tab-content">
                <!-- All sections for the private attendance tracker will be injected here -->
            </div>

            <div id="content-latecoming" class="tab-content hidden">
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 max-w-4xl mx-auto">
                    <h2 class="text-2xl font-semibold mb-4">Record Late Learners</h2>
                    <div class="flex flex-col sm:flex-row items-center gap-4 mb-6 bg-gray-50 p-4 rounded-lg">
                         <label for="lateClassSelector" class="text-xl font-semibold">Select Class:</label>
                         <select id="lateClassSelector" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                            <option value="">-- Loading Classes --</option>
                         </select>
                    </div>
                    <div id="learnersToMarkList" class="space-y-3">
                        <p class="text-center text-gray-500">Please select a class to see the learners.</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md mb-8 max-w-4xl mx-auto">
                    <h2 class="text-2xl font-semibold mb-4">Daily Late Coming List</h2>
                    <div class="flex items-center justify-center gap-4 mb-6">
                         <h3 class="text-xl font-semibold">Date:</h3>
                         <input type="date" id="lateListDate" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                    <div id="recordedLateList" class="space-y-3">
                        <!-- Late learners will be listed here -->
                    </div>
                </div>
                 <div class="bg-white p-6 rounded-xl shadow-md mb-8 max-w-4xl mx-auto">
                    <h2 class="text-2xl font-semibold mb-4">Download Late Coming Reports</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                        <div>
                            <label for="lateReportType" class="block font-medium">Report Type</label>
                            <select id="lateReportType" class="w-full mt-1 p-3 border rounded-lg">
                                <option value="today">Today's List</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="range">Date Range</option>
                            </select>
                        </div>
                        <div>
                            <label for="lateReportFormat" class="block font-medium">Format</label>
                            <select id="lateReportFormat" class="w-full mt-1 p-3 border rounded-lg">
                                <option value="csv">CSV (for Excel)</option>
                                <option value="pdf">PDF</option>
                            </select>
                        </div>
                        <div id="lateDateRange" class="hidden md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label for="lateStartDate" class="block font-medium">Start Date</label><input type="date" id="lateStartDate" class="w-full mt-1 p-3 border rounded-lg"></div>
                            <div><label for="lateEndDate" class="block font-medium">End Date</label><input type="date" id="lateEndDate" class="w-full mt-1 p-3 border rounded-lg"></div>
                        </div>
                        <div class="md:col-span-2">
                            <button id="exportLateListBtn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition w-full">Download Report</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="content-dashboard" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 space-y-8">
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Top 10 Late Learners (This Week)</h2>
                            <div id="top-late-week" class="space-y-3"></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md">
                            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Top 10 Late Learners (This Month)</h2>
                            <div id="top-late-month" class="space-y-3"></div>
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Late Arrivals by Day of the Week</h2>
                        <div id="late-by-day-chart" class="mt-6 space-y-4"></div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="text-center p-4 text-gray-500 text-xs">
            App Version: 2.7
        </footer>

        <!-- All Modals -->
        <div id="historyModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-full overflow-y-auto">
                <div class="p-6 border-b border-gray-200 sticky top-0 bg-white">
                    <h3 id="modalTitle" class="text-2xl font-bold">Attendance History</h3>
                    <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                </div>
                <div id="modalBody" class="p-6"></div>
            </div>
        </div>
        
        <div id="messageModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl"><div class="p-6 text-center"><div id="messageText" class="text-lg mb-6"></div><div id="messageActions" class="flex justify-center gap-4"></div></div></div>
        </div>

        <div id="noteModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm"><div class="p-6"><h3 id="noteModalTitle" class="text-xl font-bold mb-4">Add Note</h3><textarea id="attendanceNoteInput" class="w-full p-2 border border-gray-300 rounded-lg" rows="3" placeholder="Optional note..."></textarea><div class="mt-4 flex justify-end gap-4"><button id="cancelNoteBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-400">Cancel</button><button id="saveNoteBtn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700">Save</button></div></div></div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, setDoc, getDoc, deleteDoc, query, where, getDocs, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase & App Config ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "AIzaSyCbhU9Y9GCDhm97fJ7LwrKI3mpjPt4ilC4", // IMPORTANT: Replace with your new, restricted API key
                authDomain: "attendance-tracker-825cc.firebaseapp.com",
                projectId: "attendance-tracker-825cc",
                storageBucket: "attendance-tracker-825cc.appspot.com",
                messagingSenderId: "539619569987",
                appId: "1:539619569987:web:15e9e25a8a7db639d63ff6",
                measurementId: "G-PQZBDQN0GL"
            };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-attendance-app';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userId = null;
        const { jsPDF } = window.jspdf;

        // --- UI Elements ---
        const el = (id) => document.getElementById(id);
        
        // --- App Initialization ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                el('app-loading').classList.add('hidden');
                el('app-container').classList.remove('hidden');
                
                setupPrivateTracker();
                setupLateComingTracker();
                setupDashboard();
                setupTabLogic();

            } else {
                try {
                    if (typeof __firebase_config !== 'undefined' && typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error during initial sign-in:", error);
                    el('app-loading').innerHTML = `<p class="text-red-500">Could not connect. Check Firebase setup and API key restrictions.</p>`;
                }
            }
        });

        // --- Tab Logic ---
        function setupTabLogic() {
            const tabs = {
                attendance: { btn: el('tab-attendance'), content: el('content-attendance'), header: true },
                latecoming: { btn: el('tab-latecoming'), content: el('content-latecoming'), header: false },
                dashboard: { btn: el('tab-dashboard'), content: el('content-dashboard'), header: false }
            };

            Object.keys(tabs).forEach(key => {
                tabs[key].btn.addEventListener('click', () => {
                    Object.values(tabs).forEach(tab => {
                        tab.content.classList.add('hidden');
                        tab.btn.classList.remove('active');
                    });
                    tabs[key].content.classList.remove('hidden');
                    tabs[key].btn.classList.add('active');
                    el('classDetailsHeader').style.visibility = tabs[key].header ? 'visible' : 'hidden';
                });
            });
        }

        // --- Error Handling ---
        let securityRuleAlertShown = false;
        function handlePermissionError(error, context) {
            console.error(`Permission Denied in ${context}:`, error);
            if (!securityRuleAlertShown) {
                securityRuleAlertShown = true; // Prevent multiple alerts
                el('app-container').classList.add('hidden');
                el('app-loading').classList.add('hidden');
                el('security-rules-display').textContent = getSecureRules();
                el('security-error-screen').classList.remove('hidden');
            }
        }

        function getSecureRules() {
            return `rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Rule 1: Secures private data
    match /artifacts/{appId}/users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    // Rule 2: Allows reading the list of shared classes and learners
    match /classes/{classId}/{document=**} {
      allow read: if request.auth != null;
    }
    // Rule 3: Allows reading and writing to the shared late records
    match /lateRecords/{recordId} {
      allow read, write: if request.auth != null;
    }
  }
}`;
        }

        // =====================================================================
        // DASHBOARD
        // =====================================================================
        function setupDashboard() {
            loadDashboardData();
        }

        async function loadDashboardData() {
            const topLateWeekEl = el('top-late-week');
            const topLateMonthEl = el('top-late-month');
            const lateByDayChartEl = el('late-by-day-chart');

            topLateWeekEl.innerHTML = '<p>Loading...</p>';
            topLateMonthEl.innerHTML = '<p>Loading...</p>';
            lateByDayChartEl.innerHTML = '<p>Loading...</p>';

            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0, 10);
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay() + 1)).toISOString().slice(0, 10); // Monday as start of week

            const q = query(collection(db, 'lateRecords'), where("date", ">=", startOfMonth));
            onSnapshot(q, (snapshot) => {
                const records = snapshot.docs.map(doc => doc.data());
                
                const monthlyCounts = records.reduce((acc, rec) => { acc[rec.learnerName] = (acc[rec.learnerName] || 0) + 1; return acc; }, {});
                const topMonthly = Object.entries(monthlyCounts).sort((a,b) => b[1] - a[1]).slice(0, 10);
                renderTopList(topLateMonthEl, topMonthly, 'month');

                const weeklyRecords = records.filter(r => r.date >= startOfWeek);
                const weeklyCounts = weeklyRecords.reduce((acc, rec) => { acc[rec.learnerName] = (acc[rec.learnerName] || 0) + 1; return acc; }, {});
                const topWeekly = Object.entries(weeklyCounts).sort((a,b) => b[1] - a[1]).slice(0, 10);
                renderTopList(topLateWeekEl, topWeekly, 'week');

                const dayCounts = [0, 0, 0, 0, 0]; // Mon-Fri
                records.forEach(rec => {
                    const day = new Date(rec.date + 'T00:00:00').getDay();
                    if (day >= 1 && day <= 5) { dayCounts[day - 1]++; }
                });
                renderDayChart(lateByDayChartEl, dayCounts);
            }, (error) => {
                if(error.code === 'permission-denied') handlePermissionError(error, 'Dashboard');
            });
        }

        function renderTopList(element, data, period) {
            if (data.length === 0) {
                element.innerHTML = `<p class="text-gray-500">No late learners recorded this ${period}.</p>`;
                return;
            }
            element.innerHTML = data.map(([name, count]) => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-md">
                    <span class="font-medium">${name}</span>
                    <span class="font-bold text-lg text-yellow-600">${count}</span>
                </div>
            `).join('');
        }

        function renderDayChart(element, data) {
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
            const max = Math.max(...data) || 1;
            element.innerHTML = days.map((day, i) => {
                const percentage = (data[i] / max) * 100;
                return `
                    <div class="flex items-center">
                        <span class="w-12 font-medium text-gray-600">${day}</span>
                        <div class="flex-grow bg-gray-200 rounded-full h-6">
                            <div class="bg-yellow-500 h-6 rounded-full text-white text-sm flex items-center justify-end pr-2" style="width: ${percentage}%">${data[i]}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }


        // =====================================================================
        // LATE COMING TRACKER (SHARED DATA)
        // =====================================================================
        
        async function setupLateComingTracker() {
            const lateListDate = el('lateListDate');
            const lateClassSelector = el('lateClassSelector');
            const learnersToMarkList = el('learnersToMarkList');
            
            lateListDate.value = new Date().toISOString().slice(0, 10);
            lateListDate.addEventListener('change', loadRecordedLateLearners);
            el('exportLateListBtn').addEventListener('click', generateLateListReport);
            el('lateReportType').addEventListener('change', (e) => {
                el('lateDateRange').classList.toggle('hidden', e.target.value !== 'range');
            });
            loadRecordedLateLearners(); 

            try {
                const classesCol = collection(db, 'classes');
                const snapshot = await getDocs(classesCol);
                
                if (snapshot.empty) {
                    lateClassSelector.innerHTML = '<option value="">-- No classes found --</option>';
                    return;
                }

                const classes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.className.localeCompare(b.className));
                lateClassSelector.innerHTML = '<option value="">-- Select a Class --</option>';
                classes.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = c.className;
                    lateClassSelector.appendChild(option);
                });

                lateClassSelector.addEventListener('change', () => {
                    const classId = lateClassSelector.value;
                    if (classId) {
                        loadLearnersForClass(classId, learnersToMarkList);
                    } else {
                        learnersToMarkList.innerHTML = '<p class="text-center text-gray-500">Please select a class to see the learners.</p>';
                    }
                });
            } catch (error) {
                if(error.code === 'permission-denied') handlePermissionError(error, 'Late Coming Class List');
                else console.error("Error loading classes:", error);
                lateClassSelector.innerHTML = '<option value="">-- Error Loading Classes --</option>';
            }
        }

        async function loadLearnersForClass(classId, container) {
            container.innerHTML = '<p class="text-center text-gray-500">Loading learners...</p>';
            try {
                const learnersCol = collection(db, `classes/${classId}/learners`);
                const snapshot = await getDocs(learnersCol);

                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-center text-gray-500">No learners found for this class.</p>';
                    return;
                }

                const learners = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.name.localeCompare(b.name));
                container.innerHTML = learners.map(learner => `
                    <div class="bg-gray-50 p-4 rounded-lg flex flex-col sm:flex-row justify-between items-center" data-learner-id="${learner.id}" data-learner-name="${learner.name}" data-class-id="${classId}">
                        <span class="font-bold text-lg mb-2 sm:mb-0">${learner.name}</span>
                        <div class="flex gap-2 w-full sm:w-auto">
                            <button class="mark-late-btn flex-grow bg-yellow-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-yellow-600 transition">Mark as Late</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                if(error.code === 'permission-denied') handlePermissionError(error, 'Late Coming Learner List');
                else console.error("Error loading learners:", error);
                container.innerHTML = '<p class="text-center text-red-500">Error loading learners.</p>';
            }
        }
        
        el('learnersToMarkList').addEventListener('click', (e) => {
            const container = e.target.closest('[data-learner-id]');
            if (!container) return;
            const { learnerId, learnerName, classId } = container.dataset;

            if (e.target.classList.contains('mark-late-btn')) {
                const note = prompt(`Add an optional note for ${learnerName}:`);
                if (note !== null) recordLateComing(classId, learnerId, learnerName, note);
            }
        });

        async function recordLateComing(classId, learnerId, learnerName, note) {
            try {
                const lateCol = collection(db, 'lateRecords');
                await addDoc(lateCol, { classId, learnerId, learnerName, note: note || "No note provided", date: new Date().toISOString().slice(0, 10), timestamp: serverTimestamp(), recordedBy: userId });
                showMessage(`${learnerName} has been recorded as late.`);
            } catch (error) {
                if(error.code === 'permission-denied') handlePermissionError(error, 'Recording Late Learner');
                else {
                    console.error("Error recording late coming:", error);
                    showMessage("Failed to record late coming. Please try again.");
                }
            }
        }

        async function loadRecordedLateLearners() {
            const date = el('lateListDate').value;
            el('recordedLateList').innerHTML = '<p class="text-center text-gray-500">Loading late list...</p>';

            try {
                const classesSnap = await getDocs(collection(db, 'classes'));
                const classesMap = new Map(classesSnap.docs.map(doc => [doc.id, doc.data().className]));

                const q = query(collection(db, 'lateRecords'), where("date", "==", date));
                onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        el('recordedLateList').innerHTML = '<p class="text-center text-gray-500">No learners were recorded late on this date.</p>';
                        return;
                    }

                    const records = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})).sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

                    el('recordedLateList').innerHTML = records.map(record => {
                        const className = classesMap.get(record.classId) || 'Unknown Class';
                        return `
                            <div class="bg-gray-50 p-4 rounded-lg" data-record-id="${record.id}">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <span class="font-bold text-lg">${record.learnerName}</span>
                                        <span class="text-sm font-medium text-gray-700 ml-2">(${className})</span>
                                    </div>
                                    <button class="delete-late-record-btn bg-red-500 text-white font-semibold py-1 px-3 rounded-lg hover:bg-red-600 transition text-xs">Delete</button>
                                </div>
                                ${record.note ? `<p class="text-sm text-gray-600 mt-1 pl-1 border-l-2 border-gray-300">Note: ${record.note}</p>` : ''}
                            </div>
                        `;
                    }).join('');
                }, (error) => {
                    if(error.code === 'permission-denied') handlePermissionError(error, 'Daily Late List');
                    else {
                        console.error("Error loading late records:", error);
                        el('recordedLateList').innerHTML = '<p class="text-center text-red-500">Could not load late records.</p>';
                    }
                });
            } catch (error) {
                if(error.code === 'permission-denied') handlePermissionError(error, 'Daily Late List Class Names');
                else console.error("Error loading classes for late list:", error);
                el('recordedLateList').innerHTML = '<p class="text-center text-red-500">Could not load class names.</p>';
            }
        }
        
        el('recordedLateList').addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-late-record-btn')) {
                const container = e.target.closest('[data-record-id]');
                const { recordId } = container.dataset;
                showConfirmation('Are you sure you want to remove this late record?', () => {
                    deleteLateRecord(recordId);
                });
            }
        });

        async function deleteLateRecord(recordId) {
            try {
                await deleteDoc(doc(db, 'lateRecords', recordId));
                showMessage("Late record removed successfully.");
            } catch (error) {
                console.error("Error removing late record:", error);
                showMessage("Failed to remove late record.");
            }
        }
        
        async function generateLateListReport() {
            // This function will be updated to handle the new report types
        }


        // =====================================================================
        // PRIVATE ATTENDANCE TRACKER
        // =====================================================================
        function setupPrivateTracker() {
            el('content-attendance').innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md mb-8 max-w-4xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                             <label for="privateClassSelector" class="text-xl font-semibold">Select Class:</label>
                             <select id="privateClassSelector" class="w-full mt-2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                                <option value="">-- Loading Classes --</option>
                             </select>
                        </div>
                         <div class="bg-gray-50 p-4 rounded-lg">
                             <h3 class="text-xl font-semibold">Date:</h3>
                             <input type="date" id="attendanceDate" class="w-full mt-2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                        </div>
                    </div>
                    <div class="border-t pt-6">
                        <h2 class="text-2xl font-semibold mb-4">Session Details</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="teacherNameInput" class="block font-medium text-gray-700">Your Name</label><input type="text" id="teacherNameInput" placeholder="e.g., Mr. Smith" class="mt-1 block w-full p-3 border rounded-lg"></div>
                            <div><label for="subjectInput" class="block font-medium text-gray-700">Subject</label><input type="text" id="subjectInput" placeholder="e.g., Mathematics" class="mt-1 block w-full p-3 border rounded-lg"></div>
                            <div><label for="cycleDaySelect" class="block font-medium text-gray-700">Cycle Day</label><select id="cycleDaySelect" class="mt-1 block w-full p-3 border rounded-lg"></select></div>
                            <div><label for="periodSelect" class="block font-medium text-gray-700">Period</label><select id="periodSelect" class="mt-1 block w-full p-3 border rounded-lg"></select></div>
                        </div>
                    </div>
                </div>
                <div id="learnersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="loading" class="text-center hidden"><p class="text-lg">Loading...</p></div>
            `;
            
            bindPrivateTrackerEvents();
        }

        async function bindPrivateTrackerEvents() {
            el('attendanceDate').value = new Date().toISOString().slice(0, 10);
            el('attendanceDate').addEventListener('change', () => loadPrivateLearners(el('privateClassSelector').value));

            for (let i = 1; i <= 7; i++) {
                el('cycleDaySelect').innerHTML += `<option value="${i}">Day ${i}</option>`;
                el('periodSelect').innerHTML += `<option value="${i}">Period ${i}</option>`;
            }
            
            try {
                const classesCol = collection(db, 'classes');
                const snapshot = await getDocs(classesCol);
                const classes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.className.localeCompare(b.className));
                el('privateClassSelector').innerHTML = '<option value="">-- Select a Class --</option>';
                classes.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = c.className;
                    el('privateClassSelector').appendChild(option);
                });

                el('privateClassSelector').addEventListener('change', () => {
                    const classId = el('privateClassSelector').value;
                    const className = el('privateClassSelector').options[el('privateClassSelector').selectedIndex].text;
                    el('displayClassName').textContent = classId ? className : "[Select a Class]";

                    if (classId) {
                        loadPrivateLearners(classId);
                    } else {
                        el('learnersList').innerHTML = '<p class="text-center col-span-full">Please select a class to see the learners.</p>';
                    }
                });
            } catch (error) {
                if(error.code === 'permission-denied') handlePermissionError(error, 'Private Tracker Class List');
                else console.error("Error loading classes for private tracker:", error);
                el('privateClassSelector').innerHTML = '<option value="">-- Error Loading --</option>';
            }

            el('content-attendance').addEventListener('click', handlePrivateLearnerClick);
        }

        const privatePaths = {
            attendance: () => collection(db, `/artifacts/${appId}/users/${userId}/attendance`),
        };

        async function loadPrivateLearners(classId) {
            if (!classId) return;
            el('loading').classList.remove('hidden');
            el('learnersList').innerHTML = '';
            
            const learnersCol = collection(db, `classes/${classId}/learners`);
            const learnersSnapshot = await getDocs(learnersCol);

            if (learnersSnapshot.empty) {
                el('loading').classList.add('hidden');
                el('learnersList').innerHTML = '<p class="text-center col-span-full">No learners found for this class.</p>';
                return;
            }

            const learners = learnersSnapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.name.localeCompare(b.name));
            
            const attendancePromises = learners.map(l => getPrivateAttendanceForDate(l.id, el('attendanceDate').value));
            const attendanceRecords = await Promise.all(attendancePromises);
            
            el('loading').classList.add('hidden');
            el('learnersList').innerHTML = learners.map((learner, i) => createPrivateLearnerCardHTML(learner, attendanceRecords[i])).join('');
        }

        function createPrivateLearnerCardHTML(learner, attendance) {
             const status = attendance?.status || 'Not Marked';
            const note = attendance?.note || '';
            let statusColorClass = 'text-gray-500';
            if (status === 'Absent') statusColorClass = 'text-red-600';
            if (status === 'Late') statusColorClass = 'text-yellow-600';
            if (status === 'Bunking') statusColorClass = 'text-slate-600';
            return `
                <div class="bg-white p-5 rounded-xl shadow-lg flex flex-col space-y-4 border-2 ${status === 'Not Marked' ? 'border-gray-200' : status === 'Absent' ? 'border-red-500' : status === 'Late' ? 'border-yellow-500' : 'border-slate-500'}" data-id="${learner.id}">
                    <div class="flex-grow">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xl font-bold text-gray-900">${learner.name}</h3>
                            ${note ? '<span title="Has note" class="text-blue-500">📝</span>' : ''}
                        </div>
                        <p class="text-sm text-gray-500">Status: <span class="font-semibold ${statusColorClass}">${status}</span></p>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button class="status-btn bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition" data-status="Absent">Absent</button>
                        <button class="status-btn bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 transition" data-status="Late">Late</button>
                        <button class="status-btn bg-slate-500 text-white px-4 py-2 rounded-md hover:bg-slate-600 transition" data-status="Bunking">Bunking</button>
                        <button class="status-btn bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 transition" data-status="Not Marked">Unmark</button>
                    </div>
                    <div class="pt-2 border-t border-gray-200 mt-4 flex justify-between items-center">
                         <button class="view-history-btn text-sm text-indigo-600 hover:underline">View History</button>
                    </div>
                </div>`;
        }
        
        async function getPrivateAttendanceForDate(learnerId, date) {
            const docRef = doc(privatePaths.attendance(), `${learnerId}_${date}`);
            const docSnap = await getDoc(docRef);
            return docSnap.exists() ? {id: docSnap.id, ...docSnap.data()} : null;
        }

        async function setPrivateAttendance(learnerId, status, date, note = '') {
            const sessionDetails = {
                teacherName: el('teacherNameInput').value.trim(),
                subject: el('subjectInput').value.trim(),
                cycleDay: el('cycleDaySelect').value,
                period: el('periodSelect').value
            };

            if (status !== 'Not Marked' && (!sessionDetails.teacherName || !sessionDetails.subject)) {
                showMessage("Please enter your name and the subject before marking attendance.");
                return;
            }

            const docRef = doc(privatePaths.attendance(), `${learnerId}_${date}`);
            try {
                if (status === 'Not Marked') {
                    await deleteDoc(docRef);
                } else {
                    await setDoc(docRef, { 
                        learnerId, 
                        date, 
                        status, 
                        note, 
                        ...sessionDetails,
                        updatedAt: new Date() 
                    });
                }
                loadPrivateLearners(el('privateClassSelector').value);
                
                if (status === 'Absent' || status === 'Bunking') {
                    checkForConsecutive(learnerId, date, status);
                }

            } catch (e) { console.error("Error setting attendance: ", e); }
        }
        
        async function checkForConsecutive(learnerId, date, status) {
            let consecutiveCount = 1;
            for (let i = 1; i < 3; i++) {
                const prevDate = new Date(date);
                prevDate.setDate(prevDate.getDate() - i);
                const prevDateStr = prevDate.toISOString().slice(0, 10);
                const record = await getPrivateAttendanceForDate(learnerId, prevDateStr);
                if (record && record.status === status) {
                    consecutiveCount++;
                } else {
                    break; 
                }
            }
            if (consecutiveCount >= 3) {
                const learnerName = document.querySelector(`[data-id="${learnerId}"] h3`).textContent;
                showMessage(`ALERT: ${learnerName} has been marked as '${status}' for ${consecutiveCount} consecutive days.`);
            }
        }
        
        function handlePrivateLearnerClick(e) {
            const card = e.target.closest('[data-id]');
            if (!card) return;
            const learnerId = card.dataset.id;
            const learnerName = card.querySelector('h3').textContent;
            const date = el('attendanceDate').value;

            if (e.target.matches('.status-btn')) {
                const status = e.target.dataset.status;
                if (status === 'Absent' || status === 'Late' || status === 'Bunking') openPrivateNoteModal(learnerId, status, date, learnerName);
                else setPrivateAttendance(learnerId, status, date);
            } else if (e.target.matches('.view-history-btn')) {
                openPrivateHistoryModal(learnerId, learnerName);
            }
        }
        
        function openPrivateNoteModal(learnerId, status, date, learnerName) {
            el('noteModalTitle').textContent = `Add Note for ${learnerName} (${status})`;
            el('attendanceNoteInput').value = '';
            el('noteModal').classList.remove('hidden');
            el('saveNoteBtn').onclick = () => {
                setPrivateAttendance(learnerId, status, date, el('attendanceNoteInput').value.trim());
                el('noteModal').classList.add('hidden');
            };
        }
        el('cancelNoteBtn').addEventListener('click', () => el('noteModal').classList.add('hidden'));

        async function openPrivateHistoryModal(learnerId, learnerName) {
            el('modalTitle').textContent = `History for ${learnerName}`;
            el('modalBody').innerHTML = '<p>Loading...</p>';
            el('historyModal').classList.remove('hidden');
            const q = query(privatePaths.attendance(), where("learnerId", "==", learnerId));
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) return el('modalBody').innerHTML = '<p>No records found.</p>';
                const records = snapshot.docs.map(d => d.data()).sort((a, b) => new Date(b.date) - new Date(a.date));
                const absentCount = records.filter(r => r.status === 'Absent').length;
                const lateCount = records.filter(r => r.status === 'Late').length;
                const summaryHtml = `<div class="bg-gray-100 p-4 rounded-lg mb-4 flex justify-around text-center"><div><p class="text-2xl font-bold text-red-600">${absentCount}</p><p class="text-sm text-gray-600">Absences</p></div><div><p class="text-2xl font-bold text-yellow-600">${lateCount}</p><p class="text-sm text-gray-600">Lates</p></div></div>`;
                const historyHtml = '<ul class="space-y-3">' + records.map(r => {
                    const color = r.status === 'Present' ? 'text-green-600' : r.status === 'Absent' ? 'text-red-600' : r.status === 'Late' ? 'text-yellow-600' : 'text-slate-600';
                    const sessionInfo = r.teacherName ? `<p class="text-xs text-gray-500 mt-1">${r.subject} - Day ${r.cycleDay}, Period ${r.period} (${r.teacherName})</p>` : '';
                    return `<li class="bg-gray-50 p-3 rounded-md"><div class="flex justify-between items-center"><span class="font-medium">${r.date}</span><span class="font-semibold ${color}">${r.status}</span></div>${r.note ? `<p class="text-sm text-gray-600 mt-1 pl-1 border-l-2 border-gray-300">Note: ${r.note}</p>` : ''}${sessionInfo}</li>`;
                }).join('') + '</ul>';
                el('modalBody').innerHTML = summaryHtml + historyHtml;
            }, (error) => {
                if(error.code === 'permission-denied') handlePermissionError(error, 'Private History');
            });
        }
        el('closeModalBtn').addEventListener('click', () => el('historyModal').classList.add('hidden'));
        
        // --- Modal Helpers ---
        function showMessage(message, isSecurity = false) {
            const messageText = el('messageText');
            const messageActions = el('messageActions');
            if (isSecurity) {
                messageText.innerHTML = `<div class="text-left"><p class="font-bold text-lg mb-2 text-red-600">SECURITY RULE ERROR:</p><p class="mb-4">The app is blocked by your database rules. Please update your Firebase project's Firestore Rules with the text below:</p><pre class="bg-gray-800 text-left text-white p-4 rounded-lg text-xs overflow-x-auto whitespace-pre-wrap">${message}</pre></div>`;
            } else {
                messageText.textContent = message;
            }
            messageActions.innerHTML = `<button id="messageOkBtn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700">OK</button>`;
            el('messageModal').classList.remove('hidden');
            el('messageOkBtn').onclick = () => el('messageModal').classList.add('hidden');
        }

        function showConfirmation(message, onConfirm) {
            const messageText = el('messageText');
            const messageActions = el('messageActions');
            messageText.textContent = message;
            messageActions.innerHTML = `
                <button id="confirmYesBtn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700">Yes</button>
                <button id="confirmNoBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-400">Cancel</button>`;
            el('messageModal').classList.remove('hidden');
            el('confirmYesBtn').onclick = () => { onConfirm(); el('messageModal').classList.add('hidden'); };
            el('confirmNoBtn').onclick = () => el('messageModal').classList.add('hidden');
        }
    </script>
</body>
</html>
